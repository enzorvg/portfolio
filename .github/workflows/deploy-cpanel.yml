name: Deploy to cPanel

on:
  push:
    branches: ["main"]
    
concurrency:
  group: deploy-cpanel
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Check required secrets
        shell: bash
        run: |
          set -euo pipefail
          : "${{ secrets.CPANEL_HOST }}"
          : "${{ secrets.CPANEL_USER }}"
          : "${{ secrets.CPANEL_TOKEN }}"
          : "${{ secrets.CPANEL_REPO_ROOT }}"
          echo "Secrets presence: OK"

      - name: Update repository on cPanel (pull main)
        shell: bash
        run: |
          set -euo pipefail
          echo "Calling cPanel UAPI: VersionControl::update"
          curl --fail-with-body -sS \
            -H "Authorization: cpanel ${{ secrets.CPANEL_USER }}:${{ secrets.CPANEL_TOKEN }}" \
            "https://${{ secrets.CPANEL_HOST }}:2083/execute/VersionControl/update?repository_root=${{ secrets.CPANEL_REPO_ROOT }}&branch=main"

      - name: Deploy HEAD commit (.cpanel.yml)
        shell: bash
        run: |
          set -euo pipefail
          echo "Calling cPanel UAPI: VersionControlDeployment::create"
          curl --fail-with-body -sS \
            -H "Authorization: cpanel ${{ secrets.CPANEL_USER }}:${{ secrets.CPANEL_TOKEN }}" \
            "https://${{ secrets.CPANEL_HOST }}:2083/execute/VersionControlDeployment/create?repository_root=${{ secrets.CPANEL_REPO_ROOT }}"
